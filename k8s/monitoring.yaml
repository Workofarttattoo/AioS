apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: aios-production
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      
    scrape_configs:
    - job_name: 'aios-runtime'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - aios-production
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
    
    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: aios-production
data:
  aios-dashboard.json: |
    {
      "dashboard": {
        "title": "Ai:oS Production Metrics",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "targets": [
              {
                "expr": "rate(aios_requests_total[5m])",
                "legendFormat": "{{pod}}"
              }
            ],
            "type": "graph"
          },
          {
            "id": 2,
            "title": "Error Rate",
            "targets": [
              {
                "expr": "rate(aios_errors_total[5m]) / rate(aios_requests_total[5m])",
                "legendFormat": "Error Rate"
              }
            ],
            "type": "graph"
          },
          {
            "id": 3,
            "title": "P95 Latency",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(aios_request_duration_seconds_bucket[5m]))",
                "legendFormat": "P95"
              }
            ],
            "type": "graph"
          },
          {
            "id": 4,
            "title": "Token Usage",
            "targets": [
              {
                "expr": "rate(aios_tokens_total[5m])",
                "legendFormat": "Tokens/sec"
              }
            ],
            "type": "graph"
          },
          {
            "id": 5,
            "title": "Cost per Hour",
            "targets": [
              {
                "expr": "rate(aios_cost_usd_total[1h]) * 3600",
                "legendFormat": "USD/hour"
              }
            ],
            "type": "graph"
          },
          {
            "id": 6,
            "title": "Cache Hit Rate",
            "targets": [
              {
                "expr": "aios_cache_hits_total / (aios_cache_hits_total + aios_cache_misses_total)",
                "legendFormat": "Hit Rate"
              }
            ],
            "type": "singlestat"
          },
          {
            "id": 7,
            "title": "Agent Success Rate",
            "targets": [
              {
                "expr": "rate(aios_agent_success_total[5m]) / rate(aios_agent_calls_total[5m])",
                "legendFormat": "{{agent}}"
              }
            ],
            "type": "graph"
          },
          {
            "id": 8,
            "title": "Model Distribution",
            "targets": [
              {
                "expr": "rate(aios_model_calls_total[5m])",
                "legendFormat": "{{model}}"
              }
            ],
            "type": "pie"
          }
        ],
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        }
      }
    }

---

apiVersion: v1
kind: ServiceMonitor
metadata:
  name: aios-runtime
  namespace: aios-production
  labels:
    app: aios
spec:
  selector:
    matchLabels:
      app: aios
      component: runtime
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    scheme: http

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: alerting-rules
  namespace: aios-production
data:
  alerts.yml: |
    groups:
    - name: aios_alerts
      interval: 30s
      rules:
      
      # High error rate alert
      - alert: HighErrorRate
        expr: rate(aios_errors_total[5m]) / rate(aios_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
      
      # Critical error rate alert
      - alert: CriticalErrorRate
        expr: rate(aios_errors_total[5m]) / rate(aios_requests_total[5m]) > 0.10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "CRITICAL: Very high error rate"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 10%)"
      
      # High latency alert
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(aios_request_duration_seconds_bucket[5m])) > 1.0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High P95 latency detected"
          description: "P95 latency is {{ $value }}s (threshold: 1s)"
      
      # High cost alert
      - alert: HighCost
        expr: rate(aios_cost_usd_total[1h]) * 3600 > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High operational cost"
          description: "Cost is ${{ $value }}/hour (threshold: $100/hour)"
      
      # Pod down alert
      - alert: AiosPodDown
        expr: up{job="aios-runtime"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Ai:oS pod is down"
          description: "Pod {{ $labels.pod }} has been down for 2 minutes"
      
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: aios_cache_hits_total / (aios_cache_hits_total + aios_cache_misses_total) < 0.20
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 20%)"
      
      # Agent reliability below target
      - alert: LowAgentReliability
        expr: rate(aios_agent_success_total[10m]) / rate(aios_agent_calls_total[10m]) < 0.99
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent reliability below 99% target"
          description: "Agent {{ $labels.agent }} reliability is {{ $value | humanizePercentage }}"

